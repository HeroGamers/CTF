import os
import zipfile
import shutil
import secrets
from pathlib import Path
from Crypto.Cipher import AES
from Crypto.Util.Padding import pad
import requests
from Crypto.Util.number import bytes_to_long

# === USER INPUT ===
FOLDER_TO_TARGET = os.path.expanduser("~/Desktop/recipes")

PASTEBIN_RAW_URL = "https://pastebin.com/raw/DontTellBabushka" 

NOTE_FILENAME_INSIDE = "READ_ME_FIRST.txt"
NOTE_FILENAME_SCRIPT_SIDE = "Ransom Note.txt"

# === SETUP PATHS ===
BASE_PATH = Path(FOLDER_TO_TARGET).resolve()
OUTPUT_DIR = Path.cwd()
ZIP_NAME = BASE_PATH.name + ".zip"
ZIP_PATH = OUTPUT_DIR / ZIP_NAME
ENC_ZIP_PATH = OUTPUT_DIR / (ZIP_NAME + ".aes")
KEY_PATH = OUTPUT_DIR / "encryption.key"
SCRIPT_NOTE_PATH = OUTPUT_DIR / NOTE_FILENAME_SCRIPT_SIDE


# === 1. FETCH CONTENT FROM PASTEBIN AND DROP NOTE INTO FOLDER ===
response = requests.get(PASTEBIN_RAW_URL)
if response.status_code != 200:
    raise Exception(f"Failed to fetch pastebin: {response.status_code}")

note = response.text.strip()
note_bytes = note.encode()
note_int = bytes_to_long(note_bytes)

NOTE_CONTENT_INSIDE = note_int

note_path = BASE_PATH / NOTE_FILENAME_INSIDE
note_path.write_text(NOTE_CONTENT_INSIDE, encoding="utf-8")

# === 2. ZIP THE WHOLE FOLDER ===
with zipfile.ZipFile(ZIP_PATH, 'w', zipfile.ZIP_DEFLATED) as zipf:
    for root, dirs, files in os.walk(BASE_PATH):
        for file in files:
            full_path = Path(root) / file
            arcname = full_path.relative_to(BASE_PATH.parent)
            zipf.write(full_path, arcname)

# === 3. ENCRYPT ZIP FILE WITH AES ===
key = secrets.token_bytes(32)  # AES-256
cipher = AES.new(key, AES.MODE_CBC)
iv = cipher.iv

with open(ZIP_PATH, 'rb') as f:
    plaintext = f.read()

ciphertext = cipher.encrypt(pad(plaintext, AES.block_size))

with open(ENC_ZIP_PATH, 'wb') as f:
    f.write(iv + ciphertext)

os.remove(ZIP_PATH)

# === 4. ENCRYPT AND SAVE KEY TO FILE ===
e = 3

N= 542854524560725532346165981154184207613356788791760574237338580528855061097371463631739873747045625748589666616817388147089703349557312983383281505957873710000042058325738780863789488558278929493364652907973755819440883146036987367

# Convert key bytes to integer
key_int = int.from_bytes(key, byteorder='big')

# Encrypt using RSA: c = k^e mod N
c = pow(key_int, e, N)

# Save encrypted key as a decimal string
KEY_PATH.write_text(str(c), encoding='utf-8')

# === 5. ADD NOTE TO SCRIPT LOCATION ===
RANSOM_NOTE = f"""\
To whom it may concern,

And if you're reading this, it's definitely you.

Your Recipes are zipped and encrypted. To regain access, you must send Monero to the address below—while singing this absolute masterpiece, penned by yours truly:

XMR Wallet Address:
42ZzFakeMoneroAddressZz42FakeMoneroAddressZz42FakeMoneroAddressZz42

---

Send me all your monero, maybe
’Cause I’m beggin’

I’m beggin’, beggin’ you
So pay that ransom, won’t you, maybe
I’m beggin’, beggin’ you
Or I’ll need a real job, darling

Ridin’ high when I was “leet”
I phished them hard and fast, ’cause I had every cheat
I walked away, though you told me “Don’t go”
But easy come and easy go—my funds sank low

So anytime I spam, you shut me out
Anytime I scam, you shrug and doubt
Any lead I chase, you see right through
But I can’t bail out—don’t know what else to do

I’m on my knees when I’m beggin’
’Cause I don’t want to lose you
Hey yeah, ra-ta-ta-ta

’Cause I’m beggin’, beggin’ you
Send me all your monero, maybe
I’m beggin’, beggin’ you
Keep me from that nine-to-five, darling

I need you to understand
Tried so hard to be the big scam-man
The sort that never needs a plan
Only then can I dodge a working stand

An empty rig is all I see
The shadow of my glory is mockin’ me
A broken trojan I can’t deploy
Can’t even fool the devil—my code’s a toy

What we doin’? What’s this chasing?
Why the basement? Why the pacing?
We had decent scripts, didn’t embrace ’em
Now my wallet’s drained and I can’t replace ’em

On the wrong track from something good
I still dream up big wins like I once thought I could
Like a heart that’s beating as it should
You can slam it shut or pay me—I’m misunderstood

But I keep spamming on, keep forging forms
Keep hoping for that sweet reward
I’m stuck at home
’Cause Dad’s upstairs, I’m under his throne
Cause, I’m beggin’

Mm, yeah, I’m beggin’, beggin’ you
So pay that ransom, won’t you, maybe
I’m beggin’, beggin’ you
’Cause I’m too broke to keep on stalling

I’m fightin’ hard to hold this con
Just can’t crack it all alone
I’m hangin’ on; can’t roll it back
My final chunk of code might fade to black

I’m beggin’, beggin’ you
Send me all your monero, maybe
I’m beggin’, beggin’ you
Even 5 bucks, would be crazy, darling

I’m beggin’, beggin’ you
Stop me going legit, (oh) please
I’m beggin’, beggin’ you
Babushka is gonna end me, darling

I’m beggin’, beggin’ you
So pay that ransom, won’t you, maybe
I’m beggin’, beggin’ you
Don’t make me clock in daily!
"""

SCRIPT_NOTE_PATH.write_text(RANSOM_NOTE, encoding="utf-8")